<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package
    Name="OpenDSC Local Configuration Manager"
    Manufacturer="Thomas Nieto"
    Version="$(Version)"
    UpgradeCode="C1D2E3F4-A5B6-4C7D-8E9F-0A1B2C3D4E5F">

    <MediaTemplate EmbedCab="yes" />

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <Property Id="ARPURLINFOABOUT"
              Value="https://github.com/OpenDSC/OpenDSC" />

    <Property Id="ARPHELPLINK"
              Value="https://github.com/OpenDSC/OpenDSC/issues" />

    <WixVariable Id="WixUILicenseRtf" Value="$(LicenseRtfPath)" />
    <ui:WixUI Id="WixUI_Minimal" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="OpenDSC">
        <Directory Id="LcmRootFolder" Name="LCM">
        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="ProgramDataFolder" Name="OpenDSC">
        <Directory Id="LcmConfigFolder" Name="LCM">
          <Directory Id="LcmConfigSubFolder" Name="config">
          </Directory>
        </Directory>
      </Directory>
    </StandardDirectory>

    <Feature
      Id="ProductFeature"
      Title="Local Configuration Manager"
      Level="1">

      <ComponentGroupRef Id="AppFiles" />
      <ComponentRef Id="LcmService" />
      <ComponentRef Id="ConfigDirectory" />
    </Feature>

    <ComponentGroup Id="AppFiles" Directory="LcmRootFolder">
      <Files Include="$(var.ProjectDir)..\..\..\artifacts\Lcm\**">
        <Exclude Files="$(var.ProjectDir)..\..\..\artifacts\Lcm\**\*.pdb" />
      </Files>
    </ComponentGroup>

    <Component
      Id="LcmService"
      Directory="LcmRootFolder"
      Guid="D4E5F6A7-B8C9-4D0E-1F2A-3B4C5D6E7F8A">

      <File
        Id="LcmExecutable"
        Source="$(var.ProjectDir)..\..\..\artifacts\Lcm\OpenDsc.Lcm.exe"
        KeyPath="yes" />

      <ServiceInstall
        Id="InstallLcmService"
        Name="OpenDscLcm"
        DisplayName="OpenDSC Local Configuration Manager"
        Description="Monitors and enforces desired state configuration on this computer"
        Type="ownProcess"
        Start="demand"
        Account="LocalSystem"
        ErrorControl="normal"
        Interactive="no" />

      <ServiceControl
        Id="StartLcmService"
        Name="OpenDscLcm"
        Start="install"
        Stop="both"
        Remove="uninstall"
        Wait="yes" />

    </Component>

    <Component
      Id="ConfigDirectory"
      Directory="LcmConfigFolder"
      Guid="E5F6A7B8-C9D0-4E1F-2A3B-4C5D6E7F8A9B">

      <CreateFolder />

      <Permission
        User="Administrators"
        GenericAll="yes"
        Inheritable="no" />

      <Permission
        User="SYSTEM"
        GenericAll="yes"
        Inheritable="no" />

    </Component>

  </Package>
</Wix>
