@attribute [Authorize(Policy = "settings.write")]
@inject ServerDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudCard Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Scope Types</MudText>
            <MudText Typo="Typo.body2">Manage node categorization scopes. Higher precedence types are evaluated first.</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateScopeType" StartIcon="@Icons.Material.Filled.Add">
                Create Scope Type
            </MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else
        {
            <MudTable Items="@scopeTypes" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>Order</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Precedence</MudTh>
                    <MudTh>Allows Values</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Order">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward"
                                       Size="Size.Small"
                                       Disabled="@(context.IsSystem || context == scopeTypes.First() || (scopeTypes.IndexOf(context) > 0 && scopeTypes[scopeTypes.IndexOf(context) - 1].IsSystem))"
                                       OnClick="@(() => MoveUp(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowDownward"
                                       Size="Size.Small"
                                       Disabled="@(context.IsSystem || context == scopeTypes.Last() || (scopeTypes.IndexOf(context) < scopeTypes.Count - 1 && scopeTypes[scopeTypes.IndexOf(context) + 1].IsSystem))"
                                       OnClick="@(() => MoveDown(context))" />
                    </MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Precedence">@context.Precedence</MudTd>
                    <MudTd DataLabel="Allows Values">
                        @if (context.AllowsValues)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Yes</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default">No</MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       Disabled="@context.IsSystem"
                                       OnClick="@(() => DeleteScopeType(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudCardContent>
</MudCard>

@code {
    private List<ScopeType> scopeTypes = [];
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadScopeTypesAsync();
    }

    private async Task LoadScopeTypesAsync()
    {
        isLoading = true;
        try
        {
            scopeTypes = await Db.ScopeTypes
                .OrderByDescending(s => s.Precedence)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scope types: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CreateScopeType()
    {
        var parameters = new DialogParameters<CreateScopeTypeDialog>
        {
            { x => x.OnScopeTypeCreated, EventCallback.Factory.Create(this, LoadScopeTypesAsync) }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<CreateScopeTypeDialog>("Create Scope Type", parameters, options);
    }

    private async Task MoveUp(ScopeType scopeType)
    {
        var index = scopeTypes.IndexOf(scopeType);
        if (index <= 0) return;

        var previousItem = scopeTypes[index - 1];

        try
        {
            // Use a temporary negative value to avoid unique constraint violation
            var tempPrecedence = -(scopeType.Precedence + previousItem.Precedence);
            var scopeTypePrecedence = scopeType.Precedence;
            var previousPrecedence = previousItem.Precedence;

            scopeType.Precedence = tempPrecedence;
            await Db.SaveChangesAsync();

            scopeType.Precedence = previousPrecedence;
            previousItem.Precedence = scopeTypePrecedence;
            await Db.SaveChangesAsync();

            Snackbar.Add("Scope type order updated", Severity.Success);
            await LoadScopeTypesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating order: {ex.Message}", Severity.Error);
        }
    }

    private async Task MoveDown(ScopeType scopeType)
    {
        var index = scopeTypes.IndexOf(scopeType);
        if (index < 0 || index >= scopeTypes.Count - 1) return;

        var nextItem = scopeTypes[index + 1];

        try
        {
            // Use a temporary negative value to avoid unique constraint violation
            var tempPrecedence = -(scopeType.Precedence + nextItem.Precedence);
            var scopeTypePrecedence = scopeType.Precedence;
            var nextPrecedence = nextItem.Precedence;

            scopeType.Precedence = tempPrecedence;
            await Db.SaveChangesAsync();

            scopeType.Precedence = nextPrecedence;
            nextItem.Precedence = scopeTypePrecedence;
            await Db.SaveChangesAsync();

            Snackbar.Add("Scope type order updated", Severity.Success);
            await LoadScopeTypesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating order: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteScopeType(ScopeType scopeType)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Scope Type",
            $"Are you sure you want to delete the scope type '{scopeType.Name}'? This will also remove all associated scope values.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                Db.ScopeTypes.Remove(scopeType);
                await Db.SaveChangesAsync();
                Snackbar.Add("Scope type deleted", Severity.Success);
                await LoadScopeTypesAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting scope type: {ex.Message}", Severity.Error);
            }
        }
    }
}
