@attribute [Authorize(Policy = "settings.write")]
@inject ServerDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using Microsoft.EntityFrameworkCore
@using OpenDsc.Server.Entities

<MudCard Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Scopes</MudText>
            <MudText Typo="Typo.body2">Manage scope types and their values. Higher precedence types are evaluated first.</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateScopeType" StartIcon="@Icons.Material.Filled.Add">
                Create Scope Type
            </MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else
        {
            @foreach (var scopeType in scopeTypes)
            {
                <MudCard Class="mb-3" Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward"
                                               Size="Size.Small"
                                               Disabled="@(scopeType.IsSystem || scopeType == scopeTypes.First() || (scopeTypes.IndexOf(scopeType) > 0 && scopeTypes[scopeTypes.IndexOf(scopeType) - 1].IsSystem))"
                                               OnClick="@(() => MoveUp(scopeType))" />
                                <MudIconButton Icon="@Icons.Material.Filled.ArrowDownward"
                                               Size="Size.Small"
                                               Disabled="@(scopeType.IsSystem || scopeType == scopeTypes.Last() || (scopeTypes.IndexOf(scopeType) < scopeTypes.Count - 1 && scopeTypes[scopeTypes.IndexOf(scopeType) + 1].IsSystem))"
                                               OnClick="@(() => MoveDown(scopeType))" />
                                <MudText Typo="Typo.h6">@scopeType.Name</MudText>
                                @if (scopeType.IsSystem)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">System</MudChip>
                                }
                                @if (scopeType.ValueMode == ScopeValueMode.Restricted)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">Restricted</MudChip>
                                }
                                else if (scopeType.Name != "Node" && scopeType.Name != "Default")
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Unrestricted</MudChip>
                                }
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Precedence: @scopeType.Precedence</MudChip>
                            </MudStack>
                            @if (!string.IsNullOrEmpty(scopeType.Description))
                            {
                                <MudText Typo="Typo.body2">@scopeType.Description</MudText>
                            }
                        </CardHeaderContent>
                        <CardHeaderActions>
                            @if (scopeType.ValueMode == ScopeValueMode.Restricted && scopeType.Name != "Node")
                            {
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" OnClick="@(() => CreateScopeValue(scopeType))" StartIcon="@Icons.Material.Filled.Add">
                                    Add Value
                                </MudButton>
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           Disabled="@(scopeType.IsSystem || scopeType.Name == "Node" || scopeType.Name == "Default")"
                                           OnClick="@(() => EditScopeType(scopeType))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           Disabled="@scopeType.IsSystem"
                                           OnClick="@(() => DeleteScopeType(scopeType))" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    @if (scopeType.ValueMode == ScopeValueMode.Restricted)
                    {
                        var values = scopeValues.Where(sv => sv.ScopeTypeId == scopeType.Id).ToList();
                        @if (values.Any())
                        {
                            <MudCardContent>
                                <MudTable Items="@values" Dense="true" Hover="true">
                                    <HeaderContent>
                                        <MudTh>Value</MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh>Nodes</MudTh>
                                        <MudTh>Actions</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Value</MudTd>
                                        <MudTd>@context.Description</MudTd>
                                        <MudTd>
                                            <MudChip T="string" Size="Size.Small">@context.NodeTags.Count</MudChip>
                                        </MudTd>
                                        <MudTd>
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           OnClick="@(() => EditScopeValue(context))" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => DeleteScopeValue(context))" />
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudCardContent>
                        }
                        else
                        {
                            <MudCardContent>
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    <MudText Typo="Typo.body2">No values defined. Click "Add Value" to create predefined values.</MudText>
                                </MudAlert>
                            </MudCardContent>
                        }
                    }
                    else if (scopeType.Name == "Node")
                    {
                        <MudCardContent>
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudText Typo="Typo.body2">Node scope validates against registered nodes in the system.</MudText>
                            </MudAlert>
                        </MudCardContent>
                    }
                    else if (scopeType.Name == "Default")
                    {
                        <MudCardContent>
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudText Typo="Typo.body2">Default scope applies globally without scope values.</MudText>
                            </MudAlert>
                        </MudCardContent>
                    }
                    else
                    {
                        <MudCardContent>
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.TextFields" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">Unrestricted scope accepts any user-entered value.</MudText>
                                </MudStack>
                            </MudAlert>
                        </MudCardContent>
                    }
                </MudCard>
            }
        }
    </MudCardContent>
</MudCard>

@code {
    private List<ScopeType> scopeTypes = [];
    private List<ScopeValue> scopeValues = [];
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            scopeTypes = await Db.ScopeTypes
                .OrderByDescending(s => s.Precedence)
                .ToListAsync();

            scopeValues = await Db.ScopeValues
                .Include(sv => sv.NodeTags)
                .OrderBy(sv => sv.Value)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scopes: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CreateScopeType()
    {
        var parameters = new DialogParameters<CreateScopeTypeDialog>
        {
            [nameof(CreateScopeTypeDialog.OnScopeTypeCreated)] = EventCallback.Factory.Create(this, LoadDataAsync)
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<CreateScopeTypeDialog>("Create Scope Type", parameters, options);
    }

    private async Task EditScopeType(ScopeType scopeType)
    {
        var parameters = new DialogParameters<EditScopeTypeDialog>
        {
            [nameof(EditScopeTypeDialog.ScopeType)] = scopeType,
            [nameof(EditScopeTypeDialog.OnScopeTypeUpdated)] = EventCallback.Factory.Create(this, LoadDataAsync)
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<EditScopeTypeDialog>("Edit Scope Type", parameters, options);
    }

    private async Task EditScopeValue(ScopeValue scopeValue)
    {
        var parameters = new DialogParameters<EditScopeValueDialog>
        {
            [nameof(EditScopeValueDialog.ScopeValue)] = scopeValue,
            [nameof(EditScopeValueDialog.OnScopeValueUpdated)] = EventCallback.Factory.Create(this, LoadDataAsync)
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<EditScopeValueDialog>("Edit Scope Value", parameters, options);
    }

    private async Task CreateScopeValue(ScopeType scopeType)
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters<CreateScopeValueDialog>
        {
            [nameof(CreateScopeValueDialog.ScopeTypes)] = new List<ScopeType> { scopeType },
            [nameof(CreateScopeValueDialog.ScopeTypeId)] = scopeType.Id,
            [nameof(CreateScopeValueDialog.OnScopeValueCreated)] = EventCallback.Factory.Create(this, LoadDataAsync)
        };

        var title = scopeType.Name == "Node" ? "Add Node to Scope" : "Create Scope Value";
        await DialogService.ShowAsync<CreateScopeValueDialog>(title, parameters, options);
    }

    private async Task MoveUp(ScopeType scopeType)
    {
        var index = scopeTypes.IndexOf(scopeType);
        if (index <= 0) return;

        var previousItem = scopeTypes[index - 1];

        try
        {
            var tempPrecedence = -(scopeType.Precedence + previousItem.Precedence);
            var scopeTypePrecedence = scopeType.Precedence;
            var previousPrecedence = previousItem.Precedence;

            scopeType.Precedence = tempPrecedence;
            await Db.SaveChangesAsync();

            scopeType.Precedence = previousPrecedence;
            previousItem.Precedence = scopeTypePrecedence;
            await Db.SaveChangesAsync();

            Snackbar.Add("Scope type order updated", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating order: {ex.Message}", Severity.Error);
        }
    }

    private async Task MoveDown(ScopeType scopeType)
    {
        var index = scopeTypes.IndexOf(scopeType);
        if (index < 0 || index >= scopeTypes.Count - 1) return;

        var nextItem = scopeTypes[index + 1];

        try
        {
            var tempPrecedence = -(scopeType.Precedence + nextItem.Precedence);
            var scopeTypePrecedence = scopeType.Precedence;
            var nextPrecedence = nextItem.Precedence;

            scopeType.Precedence = tempPrecedence;
            await Db.SaveChangesAsync();

            scopeType.Precedence = nextPrecedence;
            nextItem.Precedence = scopeTypePrecedence;
            await Db.SaveChangesAsync();

            Snackbar.Add("Scope type order updated", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating order: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteScopeType(ScopeType scopeType)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Scope Type",
            $"Are you sure you want to delete the scope type '{scopeType.Name}'? This will also remove all associated scope values.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                Db.ScopeTypes.Remove(scopeType);
                await Db.SaveChangesAsync();
                Snackbar.Add("Scope type deleted", Severity.Success);
                await LoadDataAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting scope type: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteScopeValue(ScopeValue scopeValue)
    {
        var parameterCount = await Db.ParameterFiles
            .Where(pf => pf.ScopeTypeId == scopeValue.ScopeTypeId && pf.ScopeValue == scopeValue.Value)
            .CountAsync();

        if (parameterCount > 0)
        {
            Snackbar.Add($"Cannot delete scope value '{scopeValue.Value}' because {parameterCount} parameter(s) are using it.", Severity.Warning);
            return;
        }

        var nodeCount = scopeValue.NodeTags.Count;
        var message = nodeCount > 0
            ? $"Delete '{scopeValue.Value}'? This will remove it from {nodeCount} node(s)."
            : $"Delete '{scopeValue.Value}'?";

        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            message,
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                Db.ScopeValues.Remove(scopeValue);
                await Db.SaveChangesAsync();
                await LoadDataAsync();
                Snackbar.Add("Scope value deleted successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting scope value: {ex.Message}", Severity.Error);
            }
        }
    }
}
