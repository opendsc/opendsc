@using Microsoft.EntityFrameworkCore
@inject ServerDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService Dialog

<MudCard Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Scope Values</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateScopeValue" StartIcon="@Icons.Material.Filled.Add">
                Create Scope Value
            </MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudTable Items="@scopeValues" Hover="true" Dense="true" Loading="@loading">
            <HeaderContent>
                <MudTh>Scope Type</MudTh>
                <MudTh>Value</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Nodes</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ScopeType.Name</MudTd>
                <MudTd>@context.Value</MudTd>
                <MudTd>@context.Description</MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small">@context.NodeTags.Count</MudChip>
                </MudTd>
                <MudTd>@context.CreatedAt.LocalDateTime.ToString("g")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="@(() => DeleteScopeValue(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private List<ScopeValue> scopeValues = [];
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadScopeValuesAsync();
    }

    private async Task LoadScopeValuesAsync()
    {
        loading = true;
        try
        {
            scopeValues = await Db.ScopeValues
                .Include(sv => sv.ScopeType)
                .Include(sv => sv.NodeTags)
                .OrderBy(sv => sv.ScopeType.Precedence)
                .ThenBy(sv => sv.Value)
                .ToListAsync();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CreateScopeValue()
    {
        var scopeTypes = await Db.ScopeTypes
            .Where(st => st.AllowsValues)
            .OrderByDescending(st => st.Precedence)
            .ToListAsync();

        if (!scopeTypes.Any())
        {
            Snackbar.Add("No scope types found. Create a scope type first.", Severity.Warning);
            return;
        }

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters<CreateScopeValueDialog>
        {
            { x => x.ScopeTypes, scopeTypes },
            { x => x.OnScopeValueCreated, EventCallback.Factory.Create(this, LoadScopeValuesAsync) }
        };

        await Dialog.ShowAsync<CreateScopeValueDialog>("Create Scope Value", parameters, options);
    }

    private async Task DeleteScopeValue(ScopeValue scopeValue)
    {
        var nodeCount = scopeValue.NodeTags.Count;
        var message = nodeCount > 0
            ? $"Delete '{scopeValue.Value}'? This will remove it from {nodeCount} node(s)."
            : $"Delete '{scopeValue.Value}'?";

        var confirmed = await Dialog.ShowMessageBox(
            "Confirm Delete",
            message,
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                Db.ScopeValues.Remove(scopeValue);
                await Db.SaveChangesAsync();
                await LoadScopeValuesAsync();
                Snackbar.Add("Scope value deleted successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting scope value: {ex.Message}", Severity.Error);
            }
        }
    }
}
